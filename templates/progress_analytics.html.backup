{% extends "base.html" %}

{% block title %}Progress Tahlili - EDUAI Pro{% endblock %}

{% block extra_css %}
<style>
    .analytics-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
    }

    .stats-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem;
        margin: 0.5rem 0;
    }

    .progress-card {
        border: none;
        border-radius: 15px;
        transition: all 0.3s ease;
    }

    .progress-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .subject-progress {
        height: 8px;
    }

    .timeline-item {
        border-left: 3px solid #007bff;
        padding-left: 1rem;
        margin-bottom: 1.5rem;
    }

    .timeline-date {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .performance-badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.8rem;
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    .insight-card {
        border-left: 4px solid #28a745;
        background: #f8fff9;
    }

    .improvement-card {
        border-left: 4px solid #ffc107;
        background: #fffbf0;
    }

    .filter-btn {
        border-radius: 20px;
        margin: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="analytics-hero">
            <div class="row align-items-center py-5">
                <div class="col-lg-8">
                    <div class="px-4">
                        <h1 class="display-5 fw-bold text-white mb-3">
                            <i class="fas fa-chart-line me-3"></i>Progress Tahlili
                        </h1>
                        <p class="lead mb-4 opacity-90">
                            Batafsil statistikalar, tahlillar va AI tavsiyalari.
                            O'z bilimingizni har tomondan kuzating va rivojlangan.
                        </p>
                        <div class="d-flex flex-wrap gap-3">
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-brain me-1"></i>AI Tahlil
                            </span>
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-trend-up me-1"></i>Progress Trend
                            </span>
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-lightbulb me-1"></i>Shaxsiy Tavsiyalar
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 text-center">
                    <div class="hero-graphic">
                        <i class="fas fa-analytics fa-8x opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Asosiy Statistikalar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <h3 class="text-primary mb-1">{{ current_user.get_overall_progress() }}%</h3>
                                <small class="text-muted">Umumiy Progress</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <h3 class="text-success mb-1">{{ current_user.get_avg_test_score() }}%</h3>
                                <small class="text-muted">O'rtacha Test Ball</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <h3 class="text-warning mb-1">{{ current_user.get_tests_taken() }}</h3>
                                <small class="text-muted">Topshirilgan Testlar</small>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-card">
                                <h3 class="text-info mb-1">{{ (current_user.progress|selectattr("progress_percentage",
                                    "ge", 70)|list|length) }}</h3>
                                <small class="text-muted">Yaxshi Fanlar</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Chap Panel - Progress Diagrammalari -->
        <div class="col-lg-8">
            <!-- Fanlar Progressi -->
            <div class="card progress-card mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2 text-primary"></i>Fanlar Bo'yicha Progress
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="subjectProgressChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Progress Trendi -->
            <div class="card progress-card mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trend-up me-2 text-success"></i>Progress Trendi (Oxirgi 30 kun)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="progressTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Test Natijalari -->
            <div class="card progress-card">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2 text-info"></i>Test Natijalari Tahlili
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="testResultsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- O'ng Panel - Tahlillar va Tavsiyalar -->
        <div class="col-lg-4">
            <!-- AI Tahlillari -->
            <div class="card progress-card mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-robot me-2 text-primary"></i>AI Tahlillari
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Kuchli Tomonlar -->
                    <div class="insight-card p-3 mb-3">
                        <h6 class="text-success">
                            <i class="fas fa-star me-2"></i>Kuchli Tomonlaringiz
                        </h6>
                        <ul class="mb-0">
                            {% for progress in current_user.progress %}
                            {% if progress.progress_percentage >= 80 %}
                            {% set subject = subjects|selectattr("id", "equalto", progress.subject_id)|first %}
                            {% if subject %}
                            <li>{{ subject.name }} ({{ progress.progress_percentage }}%)</li>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Takomillashtirish Kerak -->
                    <div class="improvement-card p-3 mb-3">
                        <h6 class="text-warning">
                            <i class="fas fa-bullseye me-2"></i>Takomillashtirish Kerak
                        </h6>
                        <ul class="mb-0">
                            {% for progress in current_user.progress %}
                            {% if progress.progress_percentage < 50 %} {% set
                                subject=subjects|selectattr("id", "equalto" , progress.subject_id)|first %} {% if
                                subject %} <li>{{ subject.name }} ({{ progress.progress_percentage }}%)</li>
                                {% endif %}
                                {% endif %}
                                {% endfor %}
                        </ul>
                    </div>

                    <!-- Tavsiyalar -->
                    <div class="alert alert-info">
                        <h6>
                            <i class="fas fa-lightbulb me-2"></i>Shaxsiy Tavsiya
                        </h6>
                        <p class="small mb-2" id="aiRecommendation">
                            <!-- AI tavsiyasi JavaScript orqali yuklanadi -->
                        </p>
                        <button class="btn btn-sm btn-outline-info" onclick="generateAITip()">
                            <i class="fas fa-sync me-1"></i>Yangi Tavsiya
                        </button>
                    </div>
                </div>
            </div>

            <!-- So'nggi Faoliyat -->
            <div class="card progress-card mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2 text-secondary"></i>So'nggi Faoliyat
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for result in test_results[:5] %}
                        <div class="timeline-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ result.subject.name if result.subject else 'Test' }}</h6>
                                    <span class="badge performance-badge 
                                        {% if result.score >= 80 %}bg-success
                                        {% elif result.score >= 60 %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {{ result.score }}%
                                    </span>
                                </div>
                                <small class="timeline-date">{{ result.completed_at.strftime('%Y-%m-%d %H:%M')
                                    }}</small>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>Hali test natijalari mavjud emas</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Tez Filtrlash -->
            <div class="card progress-card">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2 text-info"></i>Ma'lumotlarni Filtrlash
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap">
                        <button class="btn btn-outline-primary btn-sm filter-btn active" data-filter="all">
                            Barchasi
                        </button>
                        <button class="btn btn-outline-primary btn-sm filter-btn" data-filter="week">
                            Oxirgi Hafta
                        </button>
                        <button class="btn btn-outline-primary btn-sm filter-btn" data-filter="month">
                            Oxirgi Oy
                        </button>
                        <button class="btn btn-outline-primary btn-sm filter-btn" data-filter="best">
                            Eng Yaxshilari
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Batafsil Progress Jadvali -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card progress-card">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2 text-primary"></i>Batafsil Progress Jadvali
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fan</th>
                                    <th>Progress</th>
                                    <th>Oxirgi Test</th>
                                    <th>O'rtacha Ball</th>
                                    <th>Status</th>
                                    <th>Harakatlar</th>
                    </div>
                </div>
            </div>
            {% endblock %}

            {% block extra_js %}
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // AI tavsiyasini yuklash
                    generateAITip();

                    // Fanlar progress diagrammasi
                    const subjectCtx = document.getElementById('subjectProgressChart').getContext('2d');
                    const subjectData = {
                        labels: [
                            {% for progress in current_user.progress %}
                    {% set subject = subjects | selectattr("id", "equalto", progress.subject_id) | first %}
                    {% if subject %} '{{ subject.name }}', {% endif %}
            {% endfor %}
        ],
                    datasets: [{
                        label: 'Progress %',
                        data: [
                            {% for progress in current_user.progress %}
                {{ progress.progress_percentage }},
                    {% endfor %}
                ],
                    backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ],
                    borderWidth: 2
        }]
    };

                new Chart(subjectCtx, {
                    type: 'bar',
                    data: subjectData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': ' + context.raw + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function (value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });

                // Progress trend diagrammasi (mock data)
                const trendCtx = document.getElementById('progressTrendChart').getContext('2d');
                const trendData = {
                    labels: {{ trend_labels | tojson }},
                datasets: [{
                    label: 'O\'rtacha Progress Trendi',
                    data: {{ trend_data | tojson }},
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    fill: true
        }]
    };

                new Chart(trendCtx, {
                    type: 'line',
                    data: trendData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function (value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });

                // Test natijalari diagrammasi
                const testCtx = document.getElementById('testResultsChart').getContext('2d');
                const testData = {
                    labels: [
                        {% for result in test_results[: 6] %}
                '{{ result.subject.name if result.subject else "Test" }}',
                    'rgba(255, 159, 64, 0.6)'
                ],
                borderWidth: 2
        }]
    };

                new Chart(testCtx, {
                    type: 'pie',
                    data: testData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.label + ': ' + context.raw + '%';
                                    }
                                }
                            }
                        }
                    }
                });

                // Filtrlash
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');

                        const filter = this.getAttribute('data-filter');
                        filterData(filter);
                    });
                });

                function filterData(filter) {
                    console.log('Filter:', filter);
                    // Bu yerda filtrlash logikasi bo'ladi
                    // Hozircha faqat konsolga chiqaramiz
                }
});

                function generateAITip() {
                    const tips = [
                        "Matematika bo'yicha ajoyib natijalar! Keyingi bosqich sifatida trigonometriyani chuqurroq o'rganing.",
                        "Fizika fanida yaxshi progress qilyapsiz. Elektromagnetizm mavzusiga e'tibor bering.",
                        "Ingliz tilida grammatika bilimingizni mustahkamlang. Kundalik mashq qilish yordam beradi.",
                        "Dasturlash asoslarini yaxshi o'zlashtirgansiz. Endi loyihalar yaratishga o'tishingiz mumkin.",
                        "Har kuni kamida 30 daqiqa dars o'tish progressni tez oshirishga yordam beradi.",
                        "Test natijalaringizga qarab, zaif tomonlaringizga ko'proq vaqt ajrating.",
                        "Murakkab mavzularni kichik qismlarga bo'lib o'rganish samaraliroq.",
                        "O'qigan mavzularingizni takrorlash bilimmingizni mustahkamlaydi."
                    ];

                    const randomTip = tips[Math.floor(Math.random() * tips.length)];
                    document.getElementById('aiRecommendation').textContent = randomTip;
                }
            </script>
            {% endblock %}