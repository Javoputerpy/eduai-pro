{% extends "base.html" %}

{% block title %}Bilim Markazi - EDUAI Pro{% endblock %}

{% block extra_css %}
<style>
    .test-hero {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-radius: 20px;
    }

    .test-card {
        transition: all 0.3s ease;
        border-radius: 15px;
        overflow: hidden;
    }

    .test-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }

    .quick-test-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
    }

    .filter-pill {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }

    .filter-pill.active {
        background-color: #007bff !important;
        color: white !important;
        border-color: #007bff;
    }

    .timer-display {
        font-family: 'Courier New', Courier, monospace;
        font-weight: bold;
    }

    .option-card {
        transition: all 0.2s;
        border: 2px solid #f0f0f0;
        cursor: pointer;
    }

    .option-card:hover {
        border-color: #007bff;
        background: #f8fbff;
    }

    .option-card.selected {
        border-color: #007bff;
        background: #e3f2fd;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-5">
    <div class="col-12">
        <div class="test-hero shadow-lg">
            <div class="row align-items-center py-5 px-4">
                <div class="col-lg-8">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="fas fa-tasks me-3"></i>Bilim Markazi (Testlar)
                    </h1>
                    <p class="lead mb-4 opacity-90">
                        O'z bilimingizni turli darajadagi testlar va AI vazifalar bilan sinab ko'ring.
                    </p>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-white text-primary rounded-pill px-4 fw-bold shadow-sm"
                            id="randomTestBtn">
                            <i class="fas fa-random me-2"></i>Tasodifiy Test
                        </button>
                    </div>
                </div>
                <div class="col-lg-4 text-center d-none d-lg-block">
                    <i class="fas fa-bolt fa-8x opacity-25"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-8">
        <!-- Search and Filters -->
        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="input-group rounded-pill overflow-hidden border">
                            <span class="input-group-text bg-white border-0"><i
                                    class="fas fa-search text-muted"></i></span>
                            <input type="text" id="testSearch" class="form-control border-0 py-2"
                                placeholder="Testlarni qidirish...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2 overflow-auto" id="difficultyFilters">
                            <span class="badge bg-light text-dark p-2 px-3 filter-pill active"
                                data-diff="all">Barchasi</span>
                            <span class="badge bg-light text-dark p-2 px-3 filter-pill"
                                data-diff="beginner">Boshlang'ich</span>
                            <span class="badge bg-light text-dark p-2 px-3 filter-pill"
                                data-diff="intermediate">O'rta</span>
                            <span class="badge bg-light text-dark p-2 px-3 filter-pill"
                                data-diff="advanced">Murakkab</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tests Grid -->
        <div class="row g-4" id="testsGrid">
            {% for subject in subjects %}
            <div class="col-md-6 test-item" data-name="{{ subject.name }}" data-diff="beginner">
                <div class="card test-card h-100 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between mb-3">
                            <span class="badge bg-success-subtle text-success">Boshlang'ich</span>
                            <small class="text-muted"><i class="far fa-clock me-1"></i>15 daqiqa</small>
                        </div>
                        <h5 class="fw-bold mb-2">{{ subject.name }} - Asoslar</h5>
                        <p class="text-muted small mb-4">Ushbu fanning asosiy tushunchalari va poydevor bilimlarini
                            sinovdan o'tkazing.</p>
                        <button class="btn btn-primary w-100 rounded-pill start-test" data-subject-id="{{ subject.id }}"
                            data-subject-name="{{ subject.name }}" data-difficulty="beginner">
                            <i class="fas fa-play me-2"></i>Testni Boshlash
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6 test-item" data-name="{{ subject.name }}" data-diff="intermediate">
                <div class="card test-card h-100 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between mb-3">
                            <span class="badge bg-warning-subtle text-warning">O'rta</span>
                            <small class="text-muted"><i class="far fa-clock me-1"></i>20 daqiqa</small>
                        </div>
                        <h5 class="fw-bold mb-2">{{ subject.name }} - Murakkab</h5>
                        <p class="text-muted small mb-4">Chuqurroq bilimlar va mantiqiy savollar to'plami bilan o'z
                            darajangizni aniqlang.</p>
                        <button class="btn btn-outline-primary w-100 rounded-pill start-test"
                            data-subject-id="{{ subject.id }}" data-subject-name="{{ subject.name }}"
                            data-difficulty="intermediate">
                            <i class="fas fa-play me-2"></i>Testni Boshlash
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Test Stats -->
        <div class="card border-0 shadow-sm mb-4 rounded-4 overflow-hidden">
            <div class="card-header bg-primary text-white border-0 py-3">
                <h6 class="fw-bold mb-0"><i class="fas fa-chart-pie me-2"></i>Sizning Statistikangiz</h6>
            </div>
            <div class="card-body">
                <div class="row text-center g-0">
                    <div class="col-6 border-end py-3">
                        <h4 class="fw-bold text-primary mb-0">{{ current_user.get_tests_taken() }}</h4>
                        <small class="text-muted">Testlar</small>
                    </div>
                    <div class="col-6 py-3">
                        <h4 class="fw-bold text-success mb-0">{{ total_progress }}%</h4>
                        <small class="text-muted">Progress</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Results -->
        <div class="card border-0 shadow-sm mb-4 rounded-4">
            <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between">
                <h6 class="fw-bold mb-0">So'nggi Natijalar</h6>
                <a href="{{ url_for('progress_analytics') }}" class="small text-decoration-none">Hammasi</a>
            </div>
            <div class="card-body px-4">
                <div class="list-group list-group-flush">
                    {% for result in recent_results %}
                    <div class="list-group-item px-0 py-3 border-0 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 small fw-bold">{{ result.subject.name if result.subject else 'Test' }}
                                </h6>
                                <small class="text-muted">{{ result.completed_at.strftime('%d.%m %H:%M') if
                                    result.completed_at else 'Yaqinda' }}</small>
                            </div>
                            <span
                                class="badge {% if result.score >= 80 %}bg-success text-white{% else %}bg-warning text-dark{% endif %} rounded-pill">
                                {{ result.score }}%
                            </span>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <p class="text-muted small">Natijalar hozircha yo'q</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Modal -->
<div class="modal fade" id="testModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="testTitle">Test</h5>
                <div class="timer-display h4 mb-0 ms-auto text-danger" id="testTimer">15:00</div>
                <button type="button" class="btn-close ms-3" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" id="testContent">
                <!-- Loaded via JS -->
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered text-center">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-body p-5" id="resultsContent">
                <!-- Loaded via JS -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let testTimer, userAnswers = {}, questions = [], currentIdx = 0;

        // Search & Filters
        const searchInput = document.getElementById('testSearch');
        const filterPills = document.querySelectorAll('.filter-pill');

        function filterTests() {
            const term = searchInput.value.toLowerCase();
            const activeDiff = document.querySelector('.filter-pill.active').dataset.diff;

            document.querySelectorAll('.test-item').forEach(card => {
                const name = card.dataset.name.toLowerCase();
                const diff = card.dataset.diff;
                const matchName = name.includes(term);
                const matchDiff = activeDiff === 'all' || diff === activeDiff;
                card.style.display = (matchName && matchDiff) ? 'block' : 'none';
            });
        }

        searchInput.addEventListener('input', filterTests);
        filterPills.forEach(pill => {
            pill.addEventListener('click', () => {
                filterPills.forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                filterTests();
            });
        });

        // Start Test
        document.querySelectorAll('.start-test').forEach(btn => {
            btn.addEventListener('click', () => startTest(btn.dataset.subjectId, btn.dataset.subjectName, btn.dataset.difficulty));
        });

        document.getElementById('randomTestBtn').addEventListener('click', () => {
            const btns = document.querySelectorAll('.start-test');
            const randomBtn = btns[Math.floor(Math.random() * btns.length)];
            randomBtn.click();
        });

        async function startTest(id, name, diff) {
            const modal = new bootstrap.Modal(document.getElementById('testModal'));
            document.getElementById('testTitle').innerText = `${name} - ${diff.toUpperCase()}`;
            document.getElementById('testContent').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            modal.show();

            try {
                const resp = await fetch(`/api/start_test/${id}`);
                const data = await resp.json();
                questions = data.questions;
                currentIdx = 0;
                userAnswers = {};
                startTimer(900);
                renderQuestion();
            } catch (e) {
                document.getElementById('testContent').innerHTML = `<div class="alert alert-danger">Xatolik: ${e.message}</div>`;
            }
        }

        function renderQuestion() {
            const q = questions[currentIdx];
            const content = document.getElementById('testContent');
            content.innerHTML = `
                <div class="mb-4">
                    <span class="badge bg-primary-subtle text-primary mb-2">Savol ${currentIdx + 1}/${questions.length}</span>
                    <h5 class="fw-bold mb-4">${q.question_text}</h5>
                    <div class="options">
                        ${Object.entries(q.options).map(([k, v]) => `
                            <div class="option-card p-3 rounded-4 mb-2 ${userAnswers[q.id] === k ? 'selected' : ''}" onclick="select('${q.id}', '${k}')">
                                <strong>${k})</strong> ${v}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-light rounded-pill px-4" onclick="prev()" ${currentIdx === 0 ? 'disabled' : ''}>Ortga</button>
                    <button class="btn btn-primary rounded-pill px-4" onclick="next()">
                        ${currentIdx === questions.length - 1 ? 'Yakunlash' : 'Keyingi'}
                    </button>
                </div>
            `;
        }

        window.select = (qid, val) => { userAnswers[qid] = val; renderQuestion(); };
        window.prev = () => { if (currentIdx > 0) { currentIdx--; renderQuestion(); } };
        window.next = () => {
            if (!userAnswers[questions[currentIdx].id]) return alert('Javobni tanlang!');
            if (currentIdx < questions.length - 1) { currentIdx++; renderQuestion(); }
            else finish();
        };

        function startTimer(sec) {
            if (testTimer) clearInterval(testTimer);
            let left = sec;
            testTimer = setInterval(() => {
                left--;
                const m = Math.floor(left / 60), s = left % 60;
                document.getElementById('testTimer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (left <= 0) finish();
            }, 1000);
        }

        async function finish() {
            clearInterval(testTimer);
            const score = questions.reduce((acc, q) => acc + (userAnswers[q.id] === q.correct_option ? 1 : 0), 0);
            const percent = Math.round((score / questions.length) * 100);

            bootstrap.Modal.getInstance(document.getElementById('testModal')).hide();
            const resModal = new bootstrap.Modal(document.getElementById('resultsModal'));
            resModal.show();

            document.getElementById('resultsContent').innerHTML = '<div class="spinner-border"></div>';

            try {
                const resp = await fetch('/api/submit_test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subject_id: questions[0].subject_id,
                        answers: userAnswers,
                        score: percent,
                        correct_answers: score,
                        total_questions: questions.length
                    })
                });
                const data = await resp.json();
                document.getElementById('resultsContent').innerHTML = `
                    <i class="fas fa-trophy fa-5x text-warning mb-4"></i>
                    <h2 class="fw-bold">${percent}%</h2>
                    <p class="text-muted">Test yakunlandi! +${data.points || 0} ball to'pladingiz.</p>
                    <button class="btn btn-primary rounded-pill w-100 py-2" onclick="location.reload()">Sahifani yangilash</button>
                `;
            } catch (e) { /* error handling */ }
        }
    });
</script>
{% endblock %}